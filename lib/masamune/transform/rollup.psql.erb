<%- target_partition = target.partition_table(date) %>
<%- source_partition = source.partition_table(date) %>
<%- target_stage = target_partition.stage_table %>

BEGIN;

DROP TABLE IF EXISTS <%= target_stage.name %> CASCADE;

CREATE TABLE IF NOT EXISTS <%= target_stage.name %> (LIKE <%= target.name %> INCLUDING ALL);

ALTER TABLE <%= target_stage.name %> ADD CONSTRAINT <%= target_stage.name %>_time_key_check <%= target_stage.constraints %>;
<%- target.foreign_key_columns.each do |column| -%>
ALTER TABLE <%= target_stage.name %> ADD CONSTRAINT <%= target_stage.name %>_<%= column.name %>_fkey FOREIGN KEY (<%= column.name %>) <%= column.reference_constraint %>;
<%- end -%>

COMMIT;

BEGIN;

INSERT INTO
  <%= target_stage.name %> (<%= target.rollup_columns.map{|k, v| "#{k}"}.join(', ') %>,time_key)
SELECT
  <%- target.rollup_columns.each do |k, v| -%>
  <%- if k.eql? :total -%>
        SUM(<%= k%><%='),'%>
  <%- else -%>
        <%= k %><%=',' %>
  <%- end -%>
  <%- end -%><%=target_partition.startTime%>
FROM
  <%= source_partition.name %>
GROUP BY
 <%= target.rollup_columns.map{|k, v| "#{k}"}.join(', ') %>
;
COMMIT;

BEGIN;

<%- target.index_columns.each do |column_names, unique| -%>
<%- index_name = "#{target_stage.name}_#{column_names.join('_')}_index" -%>
CREATE <%= unique ? 'UNIQUE INDEX' : 'INDEX' %> <%= index_name %> ON <%= target_stage.name %> (<%= column_names.join(', ') %>);
<%- end -%>
COMMIT;

BEGIN;
DROP TABLE IF EXISTS <%= target_partition.name %>;
ALTER TABLE <%= target_stage.name %> RENAME TO <%= target_partition.name %>;
ALTER TABLE <%= target_partition.name %> INHERIT <%= target.name %>;
ALTER TABLE <%= target_partition.name %> ADD CONSTRAINT <%= target_partition.name %>_time_key_check <%= target_partition.constraints %> NOT VALID;
<%- target.foreign_key_columns.each do |column| -%>
    ALTER TABLE <%= target_partition.name %> ADD CONSTRAINT <%= target_partition.name %>_<%= column.name %>_fkey FOREIGN KEY (<%= column.name %>) <%= column.reference_constraint %> NOT VALID;
<%- end -%>
<%- target.index_columns.each do |column_names, unique| -%>
    <%- old_index_name = "#{target_stage.name}_#{column_names.join('_')}_index" -%>
    <%- new_index_name = "#{target_partition.name}_#{column_names.join('_')}_index" -%>
    ALTER INDEX <%= old_index_name %> RENAME TO <%= new_index_name %>;
<%- end -%>
COMMIT;